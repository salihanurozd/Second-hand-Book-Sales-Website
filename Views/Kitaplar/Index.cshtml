@model IEnumerable<KitaplikApp.Models.Kitaplar>
@using System.Security.Claims;

@{
    ViewData["Title"] = "Tüm Kitaplar";
    bool isAdminPage = (bool)(ViewBag.IsAdminPage ?? false);
}

<h1>@ViewData["Title"]</h1>

<p>
    @if (isAdminPage) 
    {
        <button type="button" class="btn btn-primary btn-modal-open" data-bs-toggle="modal" data-bs-target="#modalPlaceholder"
                data-url="@Url.Action("Upsert", new { id = 0 })"
                title="Yeni Kitap Ekle">Yeni Kitap Ekle</button>
    }
</p>

<div id="statusMessageContainer" class="mt-3">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
</div>

@if (Model.Any())
{
    <table class="table table-striped table-hover mt-3">
        <thead>
            <tr>
                <th>Görsel</th>
                <th>@Html.DisplayNameFor(model => model.Baslik)</th>
                <th>@Html.DisplayNameFor(model => model.Yazar)</th>
                <th>@Html.DisplayNameFor(model => model.Yayinevi)</th>
                <th>@Html.DisplayNameFor(model => model.Fiyat)</th>
                <th>@Html.DisplayNameFor(model => model.Kategori)</th>
                @* YENİ EKLENEN KOD: Stok Sütunu Başlığı *@
                <th>@Html.DisplayNameFor(model => model.Stok)</th>
                <th>@Html.DisplayNameFor(model => model.KitapDurumu)</th>
                @if (isAdminPage) 
                {
                    <th>@Html.DisplayNameFor(model => model.OnayDurumu)</th>
                }
                <th class="text-end">İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr id="kitap-@item.KitapId">
                    <td>
                        @if (item.KitapGorselleri != null && item.KitapGorselleri.Any())
                        {
                            var ilkGorsel = item.KitapGorselleri.OrderBy(g => g.GosterimSirasi).FirstOrDefault();
                            if (ilkGorsel != null && !string.IsNullOrEmpty(ilkGorsel.ResimUrl))
                            {
                                <img src="@ilkGorsel.ResimUrl" alt="@item.Baslik Kapağı" style="width: 50px; height: auto; object-fit: cover;" />
                            }
                            else
                            {
                                <img src="/images/no-image-available.png" alt="Görsel Yok" style="width: 50px; height: auto; object-fit: cover;" />
                            }
                        }
                        else
                        {
                            <img src="/images/no-image-available.png" alt="Görsel Yok" style="width: 50px; height: auto; object-fit: cover;" />
                        }
                    </td>
                    <td>@Html.DisplayFor(modelItem => item.Baslik)</td>
                    <td>@Html.DisplayFor(modelItem => item.Yazar!.YazarAdi)</td>
                    <td>@Html.DisplayFor(modelItem => item.Yayinevi!.YayineviAdi)</td>
                    <td>@Html.DisplayFor(modelItem => item.Fiyat)</td>
                    <td>@Html.DisplayFor(modelItem => item.Kategori!.KategoriAdi)</td>
                    @* YENİ EKLENEN KOD: Stok Bilgisi *@
                    <td>@Html.DisplayFor(modelItem => item.Stok)</td>
                    <td>@Html.DisplayFor(modelItem => item.KitapDurumu!.DurumAdi)</td>
                    @if (isAdminPage) 
                    {
                        <td>@Html.DisplayFor(modelItem => item.OnayDurumu)</td>
                    }
                    <td class="text-end">
                        <button type="button" class="btn btn-sm btn-info me-2 btn-modal-open"
                                data-bs-toggle="modal" data-bs-target="#modalPlaceholder"
                                data-url="@Url.Action("Details", new { id = item.KitapId })"
                                title="Kitap Detayları">Detaylar</button>
                        
                        @* Admin ve Satıcı için Düzenle ve Sil butonları *@
                        @if (isAdminPage && (User.IsInRole("Admin") || User.IsInRole("Satici")))
                        {
                            <button type="button" class="btn btn-sm btn-warning me-2 btn-modal-open"
                                    data-bs-toggle="modal" data-bs-target="#modalPlaceholder"
                                    data-url="@Url.Action("Upsert", new { id = item.KitapId })"
                                    title="Kitabı Düzenle">Düzenle</button>

                            <button type="button" class="btn btn-sm btn-danger btn-modal-open"
                                    data-bs-toggle="modal" data-bs-target="#modalPlaceholder"
                                    data-url="@Url.Action("Delete", new { id = item.KitapId })"
                                    title="Kitabı Sil">Sil</button>
                        }
                        
                        @* Sepete Ekle butonu *@
                        @if (!isAdminPage && !User.IsInRole("Admin"))
                        {
                            <button type="button" class="btn btn-sm btn-success">Sepete Ekle</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info mt-4" role="alert">
        Henüz hiç kitap bulunmamaktadır. Yeni bir kitap ekleyerek başlayabilirsiniz.
    </div>
}

@* Modallar için tek placeholder *@
<div class="modal fade" id="modalPlaceholder" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalContent">
            </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var modalPlaceholder = $('#modalPlaceholder');
            var modalContent = $('#modalContent');

            $(document).on('click', '.btn-modal-open', function (e) {
                e.preventDefault();
                var url = $(this).data('url');

                modalContent.html('<div class="d-flex justify-content-center align-items-center" style="height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>');
                $.get(url, function (data) {
                    modalContent.html(data);
                    modalPlaceholder.modal('show');
                }).fail(function() {
                    modalContent.html('<div class="alert alert-danger">İçerik yüklenemedi. Bir hata oluştu.</div>');
                });
            });

            // Upsert formunu AJAX ile gönderme
            $(document).on('submit', '#upsertForm', function (e) {
                e.preventDefault();

                var form = $(this);
                var url = form.attr('action');
                var formData = new FormData(this);

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            modalPlaceholder.modal('hide');
                            
                            var statusContainer = $('#statusMessageContainer');
                            statusContainer.html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                                 response.message +
                                                 '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                                 '</div>');
                            
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        } else {
                            modalContent.html(response); 
                        }
                    },
                    error: function (xhr, status, error) {
                        var statusContainer = $('#statusMessageContainer');
                        statusContainer.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                             'Bir hata oluştu: ' + xhr.responseText +
                                             '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                             '</div>');
                        setTimeout(function () {
                            $('.alert').alert('close');
                        }, 5000);
                        console.error('AJAX Hatası:', error);
                    }
                });
            });
            
            // Delete formunu AJAX ile gönderme
            $(document).on('submit', '#deleteForm', function (e) {
                e.preventDefault();

                var form = $(this);
                var url = form.attr('action');
                var formData = form.serialize();

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: formData,
                    success: function (response) {
                        modalPlaceholder.modal('hide');
                        var statusContainer = $('#statusMessageContainer');
                        statusContainer.empty();

                        if (response.success) {
                            $(`tr#kitap-${form.find('input[name="KitapId"]').val()}`).remove();
                            var alertDiv = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                           response.message +
                                           '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                           '</div>';
                            statusContainer.append(alertDiv);
                        } else {
                            var alertDiv = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                           response.message +
                                           '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                           '</div>';
                            statusContainer.append(alertDiv);
                        }

                        setTimeout(function () {
                            $('.alert').alert('close');
                        }, 5000);
                    },
                    error: function (xhr, status, error) {
                         modalPlaceholder.modal('hide');
                         var statusContainer = $('#statusMessageContainer');
                         statusContainer.empty();
                         var alertDiv = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                        'Bir hata oluştu: ' + xhr.responseText +
                                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                        '</div>';
                         statusContainer.append(alertDiv);
                         setTimeout(function () {
                             $('.alert').alert('close');
                         }, 5000);
                         console.error('AJAX Hatası:', error);
                    }
                });
            });
            
        });
    </script>
}