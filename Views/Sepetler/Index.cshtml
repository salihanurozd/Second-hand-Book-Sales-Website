@model KitaplikApp.Models.Sepetler

@{
    ViewData["Title"] = "Sepetim";
    decimal toplamTutar = 0;
}

<h1>Sepetim</h1>

<div id="statusMessageContainer" class="mt-3">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }
</div>

@if (Model != null && Model.SepetDetaylari != null && Model.SepetDetaylari.Any())
{
    <table class="table table-striped table-hover mt-3" id="sepetTable">
        <thead>
            <tr>
                <th>Görsel</th>
                <th>Kitap</th>
                <th>Miktar</th>
                <th>Birim Fiyat</th>
                <th>Toplam</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.SepetDetaylari)
            {
                var kitapToplam = item.Miktar * item.BirimFiyat;
                toplamTutar += kitapToplam;
                <tr id="sepet-item-@(item.SepetDetayId)">
                    <td>
                        @if (item.Kitap?.KitapGorselleri != null && item.Kitap.KitapGorselleri.Any())
                        {
                            var ilkGorsel = item.Kitap.KitapGorselleri.OrderBy(g => g.GosterimSirasi).FirstOrDefault();
                            if (ilkGorsel != null && !string.IsNullOrEmpty(ilkGorsel.ResimUrl))
                            {
                                <img src="@ilkGorsel.ResimUrl" alt="@item.Kitap?.Baslik Kapağı" style="width: 70px; height: auto; object-fit: cover;" />
                            }
                            else
                            {
                                <img src="/images/no-image-available.png" alt="Görsel Yok" style="width: 70px; height: auto; object-fit: cover;" />
                            }
                        }
                        else
                        {
                            <img src="/images/no-image-available.png" alt="Görsel Yok" style="width: 70px; height: auto; object-fit: cover;" />
                        }
                    </td>
                    <td>@item.Kitap?.Baslik</td>
                    <td>
                        <form class="update-quantity-form d-flex align-items-center" asp-action="UpdateCartItemQuantity" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="sepetDetayId" value="@item.SepetDetayId" />
                            <input type="number" name="newQuantity" value="@item.Miktar" min="1" class="form-control me-2 quantity-input" style="width: 80px;" data-sepetdetayid="@item.SepetDetayId" />
                            <button type="submit" class="btn btn-primary btn-sm d-none">Güncelle</button>
                        </form>
                    </td>
                    <td>@item.BirimFiyat.ToString("F2")</td>
                    <td id="kitap-toplam-@(item.SepetDetayId)">@kitapToplam.ToString("F2")</td>
                    <td>
                        <form class="remove-item-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="sepetDetayId" value="@item.SepetDetayId" />
                            <button type="submit" class="btn btn-danger btn-sm">Kaldır</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-end"><strong>Toplam Tutar:</strong></td>
                <td id="genelToplam"><strong>@toplamTutar.ToString("F2")</strong></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end mt-4">
        <a asp-controller="Siparisler" asp-action="Checkout" class="btn btn-success btn-lg">Siparişi Tamamla</a>
    </div>
}
else
{
    <div class="alert alert-info mt-4" role="alert"> Sepetinizde henüz hiç ürün bulunmamaktadır. </div>
    <a asp-action="Index" asp-controller="Kitaplar" class="btn btn-primary">Alışverişe Devam Et</a>
}

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Header'daki sepet sayısını güncelle
            function updateCartCount(count) {
                var cartCountElement = $('#cart-item-count');
                if (cartCountElement.length) {
                    cartCountElement.text(count);
                }
            }

            // Bildirim mesajı göster
            function showNotification(message, type = 'success') {
                var statusContainer = $('#statusMessageContainer');
                statusContainer.empty();
                var alertDiv = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                statusContainer.prepend(alertDiv);
                setTimeout(function () {
                    $('.alert').alert('close');
                }, 5000);
            }
            // Miktar değiştiğinde AJAX ile güncelle
            $(document).on('change', '.quantity-input', function () {
                $(this).closest('form').submit();
            });

            // Miktar güncelleme formu AJAX
            $(document).on('submit', '.update-quantity-form', function (e) {
                e.preventDefault();
                var form = $(this);
                var sepetDetayId = form.find('input[name="sepetDetayId"]').val();
                var newQuantity = form.find('input[name="newQuantity"]').val();
                var antiForgeryToken = form.find('input[name="__RequestVerificationToken"]').val();
                var oldQuantity = form.find('.quantity-input').data('old-quantity') || form.find('.quantity-input').prop('defaultValue');
                form.find('.quantity-input').data('old-quantity', newQuantity);

                $.ajax({
                    url: '@Url.Action("UpdateCartItemQuantity", "Sepetler")',
                    type: 'POST',
                    data: {
                        sepetDetayId: sepetDetayId,
                        newQuantity: newQuantity,
                        '__RequestVerificationToken': antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success) {
                            showNotification(response.message, 'success');
                            $('#kitap-toplam-' + sepetDetayId).text(response.itemTotalPrice);
                            $('#genelToplam').text(response.cartTotalPrice);
                            updateCartCount(response.cartItemCount);
                        } else {
                            showNotification(response.message, 'danger');
                            form.find('.quantity-input').val(oldQuantity);
                        }
                    },
                    error: function (xhr, status, error) {
                        showNotification('Miktar güncellenirken bir hata oluştu.', 'danger');
                        form.find('.quantity-input').val(oldQuantity);
                    }
                });
            });

            // Sepetten kaldırma butonu AJAX
            $(document).on('submit', '.remove-item-form', function (e) {
                e.preventDefault();
                if (!confirm('Bu ürünü sepetten kaldırmak istediğinizden emin misiniz?')) {
                    return;
                }
                var form = $(this);
                var formData = form.serialize();
                var sepetDetayId = form.find('input[name="sepetDetayId"]').val();
                $.ajax({
                    url: '@Url.Action("RemoveFromCart", "Sepetler")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            showNotification(response.message, 'success');
                            $('#sepet-item-' + sepetDetayId).remove();
                            $('#genelToplam').text(response.cartTotalPrice);
                            updateCartCount(response.cartItemCount);
                            if ($('#sepetTable tbody tr').length === 0) {
                                $('#sepetTable').hide();
                                $('#checkoutButton').hide();
                                var emptyCartHtml = `
                                    <div class="alert alert-info mt-4" role="alert"> Sepetinizde henüz hiç ürün bulunmamaktadır. </div>
                                    <a asp-action="Index" asp-controller="Kitaplar" class="btn btn-primary">Alışverişe Devam Et</a>
                                `;
                                $('#statusMessageContainer').after(emptyCartHtml);
                            }
                        } else {
                            showNotification(response.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        showNotification('Ürün sepetten kaldırılırken bir hata oluştu.', 'danger');
                    }
                });
            });
        });
    </script>
}