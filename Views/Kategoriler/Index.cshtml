@model IEnumerable<KitaplikApp.Models.Kategoriler>
@using System.Security.Claims

@{
    ViewData["Title"] = "Kategoriler";
    var userRole = User.FindFirstValue(ClaimTypes.Role);
}

<h1>Kategoriler</h1>

<div id="ajaxStatusMessageContainer" class="mt-3"></div>

@if (User.IsInRole("Admin"))
{
    <p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#upsertModal" data-id="0">
            Yeni Kategori Ekle
        </button>
    </p>
}

@if (!Model.Any())
{
    <div class="alert alert-info mt-4" role="alert">
        Henüz hiç kategori bulunmamaktadır.
        @if (User.IsInRole("Admin"))
        {
            <span>Yeni bir kategori ekleyerek başlayabilirsiniz.</span>
        }
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover mt-3">
            <thead>
                <tr>
                    <th>@Html.DisplayNameFor(model => model.KategoriAdi)</th>
                    @if (User.IsInRole("Admin"))
                    {
                        <th class="text-end">İşlemler</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="kategori-@item.KategoriId">
                        <td>@Html.DisplayFor(modelItem => item.KategoriAdi)</td>
                        @if (User.IsInRole("Admin"))
                        {
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-warning me-2 edit-btn" data-bs-toggle="modal" data-bs-target="#upsertModal" data-id="@item.KategoriId">Düzenle</button>

                                <button type="button" class="btn btn-sm btn-info me-2 details-btn" data-bs-toggle="modal" data-bs-target="#detailsModal" data-id="@item.KategoriId">Detaylar</button>

                                <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="@item.KategoriId">Sil</button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@* Upsert Modal'ı *@
<div class="modal fade" id="upsertModal" tabindex="-1" aria-labelledby="upsertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="upsertModalLabel">Kategori Ekle/Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="upsertModalBody">
        </div>
    </div>
  </div>
</div>

@* Detaylar Modal'ı *@
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Kategori Detayları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="detailsModalBody">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    @Html.AntiForgeryToken()
    <script>
        $(document).ready(function () {
            // Durum mesajlarını gösteren fonksiyon
            function showStatusMessage(isSuccess, message) {
                var statusContainer = $('#ajaxStatusMessageContainer');
                statusContainer.empty();
                var alertClass = isSuccess ? 'alert-success' : 'alert-danger';
                var alertDiv = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                statusContainer.append(alertDiv);
                setTimeout(function () {
                    $('.alert').alert('close');
                }, 5000);
            }

            // Upsert Modal İçeriğini AJAX ile yükleme
            $('#upsertModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var kategoriId = button.data('id');
                var modal = $(this);
                
                modal.find('.modal-title').text(kategoriId == 0 ? "Yeni Kategori Ekle" : "Kategori Düzenle");

                $.ajax({
                    url: '@Url.Action("Upsert", "Kategoriler")',
                    type: 'GET',
                    data: { id: kategoriId },
                    success: function (html) {
                        modal.find('#upsertModalBody').html(html);
                        $.validator.unobtrusive.parse('#upsertForm');
                    },
                    error: function () {
                        showStatusMessage(false, 'Kategori formu yüklenirken bir hata oluştu.');
                        modal.modal('hide');
                    }
                });
            });

            // Upsert Formu AJAX ile Gönderme
            $(document).on('submit', '#upsertForm', function (e) {
                e.preventDefault();
                var form = $(this);
                if (form.valid()) {
                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: form.serialize(),
                        success: function (response) {
                            if (response.success) {
                                $('#upsertModal').modal('hide');
                                showStatusMessage(true, response.message);
                                
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);

                            } else {
                                showStatusMessage(false, response.message);
                                var modelStateErrors = response.errors;
                                if (modelStateErrors && modelStateErrors.length > 0) {
                                    for(var i = 0; i < modelStateErrors.length; i++) {
                                        showStatusMessage(false, modelStateErrors[i]);
                                    }
                                }
                            }
                        },
                        error: function () {
                            showStatusMessage(false, 'Kaydetme işlemi sırasında bir hata oluştu.');
                        }
                    });
                }
            });

            // Detaylar Modal İçeriğini AJAX ile yükleme
            $('#detailsModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var kategoriId = button.data('id');
                var modal = $(this);

                $.ajax({
                    url: '@Url.Action("Details", "Kategoriler")',
                    type: 'GET',
                    data: { id: kategoriId },
                    success: function (html) {
                        modal.find('#detailsModalBody').html(html);
                    },
                    error: function () {
                        showStatusMessage(false, 'Kategori detayları yüklenirken bir hata oluştu.');
                        modal.modal('hide');
                    }
                });
            });

            // Silme İşlemi AJAX ile
            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                var kategoriId = $(this).data('id');
                var thisRow = $(this).closest('tr');

                if (confirm('Bu kategoriyi kalıcı olarak silmek istediğinizden emin misiniz?')) {
                    var token = $('input[name="__RequestVerificationToken"]').val();

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("Delete", "Kategoriler")',
                        data: { 
                            id: kategoriId,
                            __RequestVerificationToken: token
                        },
                        success: function (response) {
                            if (response.success) {
                                thisRow.remove();
                                showStatusMessage(true, response.message);
                            } else {
                                showStatusMessage(false, response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            showStatusMessage(false, 'Silme işlemi sırasında bir hata oluştu.');
                        }
                    });
                }
            });
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}